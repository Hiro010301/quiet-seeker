<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>QuietSeeker - æ¹˜å—ã‚¨ãƒªã‚¢ç‰ˆ</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        .input-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 100; background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); font-family: sans-serif;
            text-align: center; display: none; width: 320px;
        }
        .choice-btn {
            padding: 12px; border: none; border-radius: 8px; cursor: pointer;
            background: #0078ff; color: white; font-weight: bold; width: 100%; margin-top: 8px;
        }
        .facility-choice { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .status-msg {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 10; background: rgba(0,0,0,0.95); color: #00ff00;
            padding: 15px 25px; border-radius: 15px; font-family: monospace; font-size: 12px;
            max-width: 90%; min-width: 300px; line-height: 1.5;
        }
        .status-msg a { color: #00ff00; text-decoration: underline; font-weight: bold; }
        .rank-label { background: #00ff00; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="inputPanel" class="input-panel">
        <div id="setupStep">
            <b style="font-size: 18px;">ğŸ› ï¸ JFAã‚’ç”¨ã„ã¦é™ã‹ãªåœ°ç‚¹ã‚’æ¢ã™</b><br>
            <div style="margin: 15px 0; background: #f5f5f5; padding: 10px; border-radius: 8px;">
                <label id="rangeLabel" style="font-size: 13px;">è§£æåŠå¾„: 1.5km</label><br>
                <input type="range" id="radiusRange" min="0.5" max="3.0" step="0.5" value="1.5" 
                       oninput="document.getElementById('rangeLabel').innerText='è§£æåŠå¾„: '+this.value+'km'">
            </div>
            <button id="execBtn" class="choice-btn" onclick="startJFA()">æ¤œç´¢ã‚’é–‹å§‹</button>
        </div>

        <div id="facilityStep" class="facility-choice">
            <b style="color:#333;">é™ã‹ãªãƒã‚¤ãƒ³ãƒˆå‘¨è¾ºã®ã‚¹ãƒãƒƒãƒˆ</b>
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button class="choice-btn" style="background:#2c3e50;" onclick="searchFacilities('library')">ğŸ“– å›³æ›¸é¤¨</button>
                <button class="choice-btn" style="background:#d35400;" onclick="searchFacilities('cafe')">â˜• ã‚«ãƒ•ã‚§</button>
            </div>
        </div>
    </div>

    <div id="status" class="status-msg">READY: åœ°å›³ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è§£æã‚¨ãƒªã‚¢ã‚’æ±ºå®š</div>
    <div id="map"></div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
            center: [139.4470, 35.3368], // è¾»å ‚é§…
            zoom: 14
        });

        let clickedLngLat = null;
        let peakLngLat = null;
        let noiseSeeds = [];
        let centerMarker = null;
        let peakMarker = null;
        let facilityMarkers = [];
        let isAnalysing = false;

        function getDistanceKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function resetAll() {
            if (centerMarker) centerMarker.remove();
            if (peakMarker) peakMarker.remove();
            facilityMarkers.forEach(m => m.remove());
            facilityMarkers = [];
            if (map.getLayer('jfa-heat')) map.removeLayer('jfa-heat');
            if (map.getSource('jfa-field')) map.removeSource('jfa-field');
            if (map.getLayer('radius-layer')) map.removeLayer('radius-layer');
            if (map.getSource('search-radius')) map.removeSource('search-radius');
        }

        map.on('click', (e) => {
            if (isAnalysing) return;
            resetAll();
            clickedLngLat = e.lngLat;
            centerMarker = new maplibregl.Marker({ color: '#ff4444' }).setLngLat(clickedLngLat).addTo(map);
            centerMarker.getElement().title = "æŒ‡å®šã—ãŸåœ°ç‚¹";

            document.getElementById('setupStep').style.display = 'block';
            document.getElementById('facilityStep').style.display = 'none';
            document.getElementById('inputPanel').style.display = 'block';
            drawCircle(clickedLngLat, document.getElementById('radiusRange').value);
        });

        function drawCircle(center, radiusKm) {
            const points = 64; const coords = [];
            const dX = radiusKm / (111.32 * Math.cos(center.lat * Math.PI / 180));
            const dY = radiusKm / 110.574;
            for (let i = 0; i < points; i++) {
                const th = (i / points) * (2 * Math.PI);
                coords.push([center.lng + dX * Math.cos(th), center.lat + dY * Math.sin(th)]);
            }
            coords.push(coords[0]);
            if (map.getLayer('radius-layer')) map.removeLayer('radius-layer');
            if (map.getSource('search-radius')) map.removeSource('search-radius');
            map.addSource('search-radius', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'Polygon', coordinates: [coords] }}});
            map.addLayer({ id: 'radius-layer', type: 'fill', source: 'search-radius', paint: { 'fill-color': '#0078ff', 'fill-opacity': 0.1 }});
        }

        async function startJFA() {
            isAnalysing = true;
            document.getElementById('execBtn').disabled = true;
            const radiusKm = parseFloat(document.getElementById('radiusRange').value);
            const statusEl = document.getElementById('status');
            statusEl.innerText = ">> JFA: è§£æä¸­...";

            const latD = radiusKm / 111;
            const lngD = radiusKm / (111 * Math.cos(clickedLngLat.lat * Math.PI / 180));
            const query = `[out:json][timeout:25];(node["railway"~"station|subway_entrance"](${clickedLngLat.lat-latD},${clickedLngLat.lng-lngD},${clickedLngLat.lat+latD},${clickedLngLat.lng+lngD});node["highway"="bus_stop"](${clickedLngLat.lat-latD},${clickedLngLat.lng-lngD},${clickedLngLat.lat+latD},${clickedLngLat.lng+lngD}););out skel;`;

            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                noiseSeeds = data.elements.map(el => ({ lon: el.lon, lat: el.lat }));
                if (noiseSeeds.length === 0) throw new Error("ç¯„å›²å†…ã«é¨’éŸ³æºãŒã‚ã‚Šã¾ã›ã‚“");

                const gridSize = 15;
                let maxQuietScore = -1;
                const gridFeatures = [];
                for (let x = -gridSize; x <= gridSize; x++) {
                    for (let y = -gridSize; y <= gridSize; y++) {
                        const tLon = clickedLngLat.lng + (x/gridSize)*lngD;
                        const tLat = clickedLngLat.lat + (y/gridSize)*latD;
                        if (getDistanceKm(clickedLngLat.lat, clickedLngLat.lng, tLat, tLon) > radiusKm) continue;
                        let minDist = Infinity;
                        noiseSeeds.forEach(s => {
                            const d = getDistanceKm(tLat, tLon, s.lat, s.lon);
                            if (d < minDist) minDist = d;
                        });
                        gridFeatures.push({ type: 'Feature', geometry: { type: 'Point', coordinates: [tLon, tLat] }, properties: { score: minDist } });
                        if (minDist > maxQuietScore) { maxQuietScore = minDist; peakLngLat = [tLon, tLat]; }
                    }
                }

                map.addSource('jfa-field', { type: 'geojson', data: { type: 'FeatureCollection', features: gridFeatures } });
                map.addLayer({ id: 'jfa-heat', type: 'circle', source: 'jfa-field', paint: { 'circle-radius': 10, 'circle-color': ['interpolate', ['linear'], ['get', 'score'], 0, 'rgba(255,0,0,0.4)', 0.5, 'rgba(255,255,0,0.2)', 1.0, 'rgba(0,255,0,0.4)'] } });
                
                peakMarker = new maplibregl.Marker({ color: '#00ff00' }).setLngLat(peakLngLat).addTo(map);
                peakMarker.getElement().title = "é™ã‹ãªãƒã‚¤ãƒ³ãƒˆ";
                
                // --- ã“ã“ã‚’ä¿®æ­£ï¼šæŒ‡å®šã—ãŸåœ°ç‚¹ã‹ã‚‰ã€Œé™ã‹ãªãƒã‚¤ãƒ³ãƒˆã€ã¾ã§ã®ç§»å‹•è·é›¢ã‚’è¡¨ç¤º ---
                const distToPeak = getDistanceKm(clickedLngLat.lat, clickedLngLat.lng, peakLngLat[1], peakLngLat[0]);
                statusEl.innerHTML = `>> è§£æå®Œäº†: é™ã‹ãªãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®š<br>æŒ‡å®šã—ãŸåœ°ç‚¹ã‹ã‚‰é™ã‹ãªãƒã‚¤ãƒ³ãƒˆã¾ã§ ${distToPeak.toFixed(2)}km`;
                
                document.getElementById('setupStep').style.display = 'none';
                document.getElementById('facilityStep').style.display = 'block';
            } catch (err) { statusEl.innerText = "âš ï¸ " + err.message; }
            finally { isAnalysing = false; document.getElementById('execBtn').disabled = false; }
        }

        async function searchFacilities(type) {
            const typeLabel = type === 'library' ? 'å›³æ›¸é¤¨' : 'ã‚«ãƒ•ã‚§';
            const statusEl = document.getElementById('status');
            statusEl.innerText = `>> é™ã‹ãªãƒã‚¤ãƒ³ãƒˆå‘¨è¾º2kmã®${typeLabel}ã‚’æ¢ç´¢ä¸­...`;
            
            const d = 0.02; 
            const query = `[out:json][timeout:25];(nwr["amenity"="${type}"](${peakLngLat[1]-d},${peakLngLat[0]-d},${peakLngLat[1]+d},${peakLngLat[0]+d}););out center;`;

            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                const ranked = data.elements.map(el => {
                    const lon = el.lon || (el.center ? el.center.lon : null);
                    const lat = el.lat || (el.center ? el.center.lat : null);
                    if(!lon) return null;
                    let minD = Infinity;
                    noiseSeeds.forEach(s => {
                        const dist = getDistanceKm(lat, lon, s.lat, s.lon);
                        if (dist < minD) minD = dist;
                    });
                    const distFromStart = getDistanceKm(clickedLngLat.lat, clickedLngLat.lng, lat, lon);
                    return { name: el.tags.name || "åç§°ä¸æ˜ã®ã‚¹ãƒãƒƒãƒˆ", lat, lon, quietScore: minD, distFromStart };
                }).filter(x => x !== null).sort((a, b) => b.quietScore - a.quietScore).slice(0, 3);

                if (ranked.length === 0) {
                    statusEl.innerText = `>> å‘¨è¾º2kmã«${typeLabel}ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                    return;
                }

                document.getElementById('inputPanel').style.display = 'none';
                let html = `ğŸ† <b>ç©´å ´ãƒ»${typeLabel} TOP${ranked.length}</b><br>`;
                ranked.forEach((spot, i) => {
                    const googleLink = `https://www.google.com/search?q=${encodeURIComponent(spot.name + " " + typeLabel)}`;
                    html += `<span class="rank-label">#${i+1}</span> <a href="${googleLink}" target="_blank">${spot.name}</a> (æŒ‡å®šã—ãŸåœ°ç‚¹ã‹ã‚‰${spot.distFromStart.toFixed(2)}km)<br>`;
                    const m = new maplibregl.Marker({ color: '#f1c40f' }).setLngLat([spot.lon, spot.lat]).setPopup(new maplibregl.Popup().setHTML(`<b>${spot.name}</b>`)).addTo(map);
                    m.getElement().title = spot.name;
                    facilityMarkers.push(m);
                });
                statusEl.innerHTML = html;
                map.flyTo({ center: [ranked[0].lon, ranked[0].lat], zoom: 15 });
            } catch (err) { statusEl.innerText = "âš ï¸ æ–½è¨­æ¤œç´¢ã‚¨ãƒ©ãƒ¼"; }
        }
    </script>
</body>
</html>

<!-- JFAã‚’ä½¿ã£ã¦æŒ‡å®šåœ°ç‚¹ã‹ã‚‰ä¸€ç•ªé™ã‹ãªå ´æ‰€ã‚’æ¢ã—ãŸã†ãˆã§ãã“ã‹ã‚‰ä¸€ç•ªé™ï¼ˆäº¤é€šä¾¿ãŒæ‚ªã„å›³æ›¸é¤¨orã‚«ãƒ•ã‚§ã¯ãã“ã‹æ¢ã™ï¼‰ -->
